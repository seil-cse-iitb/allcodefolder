/*
 * 
 * This code receives the IR remote signal and converts into bitstream of pauses
 */
//
//25c med cool
//1000000000001000000000000000001011111101111111110000000011000111001110001001000101101110000100001110111111111100000000111010010001011011



//27 on 
//3446, 1673, 484, 1225, 483, 385, 483, 410, 484, 384, 484, 384, 483, 411, 484, 384, 483, 384, 484, 384, 510, 384, 483, 384, 484, 410, 485, 1224, 484, 384, 483, 385, 509, 384, 484, 384, 484, 410, 484, 384, 483, 385, 483, 385, 509, 384, 484, 384, 509, 385, 483, 385, 483, 384, 483, 411, 484, 384, 483, 385, 483, 410, 484, 1225, 484, 384, 483, 1253, 484, 1224, 484, 1225, 484, 1226, 509, 1226, 487, 1222, 483, 411, 483, 1226, 483, 1226, 483, 1226, 509, 1226, 483, 1226, 483, 1252, 484, 1225, 484, 1225, 512, 1224, 483, 384, 484, 384, 483, 411, 484, 384, 483, 384, 484, 410, 484, 384, 483, 385, 483, 385, 509, 1226, 483, 1225, 484, 410, 484, 384, 483, 1226, 483, 1227, 509, 1225, 484, 1226, 483, 410, 484, 384, 483, 1226, 483, 1227, 509, 384, 483, 385, 510, 384, 484, 1225, 483, 384, 484, 410, 484, 1225, 484, 384, 483, 385, 510, 384, 483, 1226, 483, 410, 484, 1225, 484, 1226, 483, 385, 509, 1226, 483, 1226, 483, 1252, 483, 384, 484, 1226, 483, 411, 483, 384, 483, 385, 483, 411, 484, 383, 484, 384, 512, 382, 484, 384, 483, 1226, 483, 1226, 510, 1225, 483, 1226, 483, 1252, 484, 1225, 484, 1225, 483, 1227, 509, 1226, 483, 1226, 483, 1252, 484, 1225, 484, 1225, 483, 385, 509, 385, 483, 385, 483, 410, 484, 384, 483, 377, 481, 421, 483, 384, 484, 1225, 509, 1201, 509, 1226, 483, 384, 484, 410, 484, 1225, 483, 385, 483, 1227, 509, 384, 483, 385, 483, 411, 483, 1226, 483, 1225, 484, 385, 509, 1225, 484, 384, 483, 1252, 484, 1226, 483, 384, 483, 1252, 484, 1226, 483, 384, 483, 411, 484, 1225, 484, 384, 511, 383, 483, 1226, 483, 384, 484, 385, 509, 1225, 484, 1225, 483, 411, 484, 1225, 484, 1225, 484, 1226, 509, 384, 483, 385, 483, 411, 484, 384, 483, 384, 483, 386, 508, 385, 483, 384, 484, 1252, 484, 1225, 483, 1226, 483, 1252, 483, 1226, 483, 1226, 510, 1200, 509, 384, 483, 385, 483, 411, 483, 384, 484, 1225, 484, 385, 509, 384, 483, 1226, 483, 1252, 484, 1226, 483, 1226, 483, 1226, 509, 384, 484, 1225, 484, 1252, 483, 384, 457, 104014, 279 

//28 ON
//3443, 1647, 509, 1226, 460, 407, 484, 410, 483, 385, 460, 408, 460, 408, 509, 384, 460, 408, 460, 408, 508, 386, 460, 407, 460, 408, 510, 1225, 460, 408, 483, 385, 486, 407, 461, 407, 460, 434, 483, 385, 483, 384, 460, 408, 510, 384, 460, 408, 511, 357, 508, 385, 460, 408, 460, 408, 510, 384, 483, 385, 459, 409, 507, 1227, 483, 385, 483, 1226, 510, 1225, 460, 1249, 460, 1250, 508, 1227, 460, 1249, 483, 385, 509, 1226, 460, 1249, 460, 1249, 510, 1225, 460, 1249, 460, 1275, 483, 1226, 461, 1248, 511, 1199, 509, 384, 461, 407, 460, 408, 508, 385, 461, 407, 461, 407, 510, 384, 460, 408, 460, 408, 508, 1226, 461, 1249, 460, 408, 509, 384, 460, 1249, 460, 1250, 509, 1226, 460, 1249, 483, 411, 483, 384, 460, 1249, 461, 1249, 509, 384, 461, 407, 512, 357, 507, 1227, 460, 408, 460, 408, 509, 1226, 460, 408, 483, 385, 508, 385, 460, 1239, 494, 384, 509, 1226, 460, 1249, 460, 408, 509, 1226, 483, 1226, 460, 1250, 509, 384, 483, 1226, 460, 408, 509, 385, 460, 407, 461, 433, 483, 385, 460, 408, 511, 357, 509, 384, 461, 1248, 461, 1249, 508, 1227, 460, 1249, 483, 1226, 510, 1225, 460, 1249, 484, 1226, 508, 1227, 460, 1248, 461, 1249, 510, 1225, 460, 1249, 460, 408, 486, 408, 460, 407, 460, 434, 483, 385, 460, 408, 460, 408, 509, 384, 460, 1249, 512, 1198, 507, 1228, 482, 1227, 460, 408, 509, 1225, 484, 384, 483, 1227, 507, 386, 460, 408, 483, 385, 510, 384, 460, 1249, 460, 408, 508, 1226, 484, 384, 460, 1250, 486, 1249, 483, 384, 460, 1250, 509, 1225, 460, 408, 460, 434, 483, 1226, 483, 385, 511, 357, 509, 1226, 483, 384, 460, 409, 508, 1227, 483, 1225, 484, 384, 510, 1226, 483, 1226, 460, 1249, 484, 409, 461, 407, 460, 408, 510, 384, 460, 408, 460, 407, 487, 397, 461, 417, 484, 1251, 483, 1226, 460, 1250, 483, 1226, 485, 1250, 460, 1249, 511, 1199, 483, 410, 460, 407, 460, 408, 509, 385, 460, 1249, 460, 408, 484, 410, 460, 1249, 460, 1249, 509, 1226, 460, 1249, 484, 1226, 483, 410, 483, 1226, 483, 1226, 509, 385, 434


//26 ON
//392, 289600, 257, 203772, 230, 541070, 3443, 1645, 459, 1276, 460, 408, 460, 408, 459, 435, 484, 383, 460, 408, 459, 435, 460, 408, 459, 408, 460, 434, 485, 383, 459, 409, 459, 1276, 484, 384, 459, 408, 512, 382, 460, 408, 459, 409, 459, 435, 484, 383, 460, 408, 451, 443, 459, 409, 459, 408, 460, 434, 485, 383, 459, 409, 459, 435, 483, 384, 460, 408, 459, 1276, 460, 408, 459, 1250, 459, 1276, 484, 1225, 460, 1249, 460, 1276, 484, 1225, 459, 408, 513, 1223, 484, 1225, 459, 1250, 459, 1276, 484, 1225, 460, 1249, 460, 1276, 484, 1225, 460, 1249, 459, 435, 484, 383, 460, 408, 460, 434, 485, 383, 460, 407, 461, 433, 460, 408, 460, 407, 461, 1275, 485, 1224, 454, 404, 465, 439, 485, 1224, 460, 1249, 536, 1199, 485, 1224, 461, 407, 460, 434, 485, 1224, 484, 1225, 460, 434, 485, 383, 484, 383, 485, 1250, 485, 383, 485, 383, 485, 1250, 486, 382, 485, 383, 485, 409, 485, 1223, 485, 383, 485, 1250, 486, 1224, 485, 382, 486, 1250, 509, 1200, 485, 1224, 536, 358, 484, 1225, 485, 382, 486, 408, 486, 382, 486, 382, 485, 409, 508, 359, 486, 382, 486, 408, 485, 1224, 486, 1223, 486, 1250, 484, 1225, 485, 1224, 485, 1250, 486, 1223, 485, 1224, 486, 1249, 509, 1201, 485, 1224, 485, 1250, 485, 1224, 485, 383, 511, 383, 485, 382, 486, 382, 486, 408, 509, 359, 485, 382, 486, 408, 486, 1223, 486, 1224, 485, 1250, 508, 1201, 485, 1224, 486, 408, 485, 383, 485, 1223, 486, 408, 486, 382, 486, 382, 486, 408, 485, 382, 486, 1223, 486, 1250, 509, 358, 486, 1223, 537, 1199, 509, 358, 486, 1214, 495, 1250, 485, 382, 486, 382, 486, 1249, 485, 383, 486, 382, 485, 1250, 485, 383, 485, 382, 486, 1250, 508, 1201, 485, 383, 485, 1250, 486, 1223, 485, 1224, 485, 409, 484, 384, 485, 382, 486, 408, 485, 383, 486, 382, 536, 358, 485, 382, 486, 1223, 486, 1250, 484, 1225, 485, 1224, 485, 1250, 486, 1223, 486, 1223, 486, 408, 509, 359, 485, 382, 486, 409, 485, 1224, 485, 382, 485, 409, 485, 1224, 485, 1224, 485, 1251, 485, 1224, 484, 1225, 484, 410, 484, 1225, 460, 1249, 537, 331, 484, 924646, 222

//25 ON
//248, 807472, 3418, 1671, 485, 1224, 511, 383, 484, 384, 485, 383, 485, 408, 485, 383, 485, 383, 509, 385, 485, 382, 486, 382, 487, 407, 485, 383, 485, 1224, 485, 409, 485, 383, 485, 382, 486, 408, 484, 384, 485, 382, 485, 409, 485, 383, 485, 383, 486, 408, 485, 382, 485, 383, 485, 409, 485, 383, 485, 383, 509, 385, 483, 384, 485, 1224, 485, 409, 484, 1225, 485, 1224, 485, 1251, 484, 1225, 485, 1224, 486, 1249, 484, 384, 485, 1224, 485, 1250, 485, 1224, 485, 1225, 486, 1249, 483, 1226, 484, 1225, 484, 1251, 485, 1224, 485, 383, 486, 408, 483, 384, 485, 383, 484, 410, 484, 384, 484, 384, 485, 409, 484, 383, 484, 1225, 487, 1249, 483, 384, 484, 384, 484, 1252, 483, 1226, 483, 1226, 486, 1249, 459, 409, 483, 384, 484, 1252, 483, 1226, 483, 384, 487, 407, 484, 384, 460, 1249, 484, 410, 459, 409, 459, 1250, 487, 407, 459, 409, 459, 402, 510, 1232, 459, 408, 460, 1249, 460, 1276, 459, 408, 460, 1249, 512, 1224, 459, 1250, 459, 409, 459, 1276, 459, 409, 459, 408, 487, 407, 459, 409, 459, 409, 459, 435, 459, 408, 460, 408, 487, 1248, 459, 1251, 483, 1226, 483, 1252, 483, 1226, 483, 1226, 485, 1250, 484, 1225, 484, 1225, 487, 1249, 483, 1226, 484, 1225, 484, 1251, 484, 384, 484, 384, 486, 408, 482, 385, 484, 384, 484, 410, 484, 384, 484, 383, 487, 1249, 484, 1225, 484, 1225, 484, 410, 484, 1225, 484, 383, 487, 407, 483, 1227, 484, 383, 485, 409, 484, 384, 484, 1225, 484, 410, 484, 1225, 484, 1225, 487, 407, 484, 1225, 485, 1224, 485, 409, 485, 1224, 485, 1224, 487, 407, 484, 384, 484, 1225, 485, 409, 484, 384, 484, 1225, 486, 408, 483, 384, 485, 1225, 484, 1251, 484, 383, 485, 1225, 484, 1251, 485, 1224, 485, 383, 486, 408, 484, 383, 485, 383, 485, 402, 485, 389, 485, 383, 487, 407, 483, 1227, 484, 1224, 485, 1251, 484, 1225, 485, 1224, 486, 1249, 485, 1225, 484, 383, 485, 409, 484, 384, 484, 383, 493, 1236, 484, 384, 485, 390, 478, 1250, 484, 1225, 491, 1225, 488, 1241, 484, 1225, 485, 383, 486, 1255, 484, 1225, 485, 383, 485, 11000000000001000000000000000001011111101111111110000000001100111100110001001000101101110100000000111111111111100000000111010010001011011011001001001101110000000011111110000100111110110


//24 ON 
//257, 1649187, 3445, 1644, 484, 1226, 508, 385, 484, 384, 484, 384, 512, 382, 483, 385, 483, 385, 509, 384, 484, 384, 483, 385, 512, 382, 483, 384, 484, 1226, 510, 383, 484, 384, 511, 357, 510, 384, 483, 385, 483, 385, 511, 382, 484, 384, 483, 385, 509, 385, 483, 384, 484, 384, 512, 382, 483, 385, 483, 385, 509, 384, 484, 384, 484, 1225, 510, 384, 484, 1225, 484, 1226, 510, 1225, 483, 1226, 483, 1226, 512, 1223, 484, 384, 483, 1226, 512, 1224, 483, 1225, 484, 1226, 509, 1226, 483, 1226, 484, 1225, 536, 1200, 483, 1225, 484, 385, 508, 385, 484, 384, 484, 384, 512, 382, 483, 385, 483, 385, 509, 384, 483, 384, 484, 1226, 512, 1223, 484, 384, 483, 385, 510, 1225, 483, 1226, 511, 1198, 510, 1226, 483, 384, 484, 384, 511, 1224, 484, 1226, 483, 384, 510, 384, 483, 379, 484, 1231, 512, 382, 483, 385, 483, 1226, 484, 410, 483, 385, 483, 384, 510, 1226, 485, 382, 484, 1226, 510, 1225, 483, 384, 484, 1225, 512, 1224, 483, 1226, 483, 385, 510, 1225, 483, 385, 483, 384, 510, 384, 484, 384, 483, 385, 511, 383, 483, 385, 483, 385, 484, 1251, 483, 1226, 483, 1226, 511, 1224, 484, 1225, 484, 1226, 509, 1226, 483, 1226, 483, 1226, 511, 1224, 484, 1225, 484, 1226, 509, 1226, 483, 384, 512, 356, 509, 385, 484, 384, 483, 385, 511, 383, 460, 407, 461, 407, 509, 1226, 484, 1226, 483, 1226, 511, 1224, 484, 384, 483, 385, 484, 409, 484, 1225, 484, 384, 510, 384, 484, 384, 483, 385, 509, 1226, 460, 1249, 483, 1226, 511, 383, 483, 1226, 484, 1226, 510, 383, 484, 1225, 484, 1225, 509, 385, 484, 384, 483, 1226, 511, 383, 484, 384, 483, 1227, 483, 410, 484, 384, 483, 1226, 511, 1224, 484, 384, 483, 1226, 510, 1225, 484, 1226, 460, 407, 511, 383, 460, 408, 460, 408, 509, 385, 460, 407, 512, 356, 508, 386, 460, 1249, 483, 1226, 510, 1226, 483, 1225, 484, 1226, 508, 1227, 460, 1249, 460, 408, 511, 383, 460, 408, 483, 385, 484, 1251, 483, 384, 484, 384, 510, 1225, 461, 1248, 484, 1226, 509, 1226, 460, 1249, 460, 408, 511, 1224, 483, 1226, 460, 408, 460, 11000000000001000000000000000001011111101111111110000000001100111100110001001000101101110100000000111111111111100000000111100010000111011011001001001101110000000011111110000100111110110

//23 ON
//3413, 1672, 483, 1226, 460, 434, 485, 383, 460, 407, 484, 410, 485, 383, 484, 384, 509, 385, 484, 383, 484, 384, 484, 410, 484, 384, 484, 1225, 484, 410, 484, 384, 483, 385, 483, 410, 485, 383, 484, 384, 484, 410, 484, 384, 483, 384, 484, 410, 484, 384, 484, 383, 484, 411, 484, 383, 484, 384, 484, 410, 484, 384, 483, 1226, 509, 385, 484, 1225, 460, 1249, 483, 1253, 484, 1225, 460, 1249, 483, 1252, 484, 384, 460, 1249, 483, 1252, 485, 1219, 489, 1225, 483, 1253, 484, 1225, 460, 1249, 460, 1275, 484, 1226, 460, 407, 461, 433, 485, 383, 460, 408, 460, 434, 484, 383, 461, 407, 509, 385, 484, 384, 460, 1249, 460, 1275, 484, 384, 460, 408, 460, 1275, 484, 1225, 483, 1226, 460, 1276, 484, 383, 461, 407, 460, 1275, 485, 1224, 484, 384, 460, 434, 460, 408, 460, 1249, 483, 411, 484, 384, 460, 1249, 483, 411, 484, 383, 461, 407, 510, 1226, 483, 384, 460, 1249, 484, 1252, 484, 384, 460, 1249, 483, 1252, 484, 1225, 460, 408, 460, 1275, 484, 384, 460, 408, 460, 434, 484, 383, 461, 407, 460, 434, 460, 408, 460, 407, 461, 1275, 484, 1225, 460, 1249, 460, 1275, 485, 1224, 461, 1249, 484, 1251, 484, 1225, 460, 1249, 460, 1276, 483, 1226, 460, 1249, 482, 1253, 484, 384, 460, 408, 460, 433, 484, 384, 461, 407, 460, 434, 484, 384, 460, 407, 461, 1275, 460, 1249, 483, 1226, 455, 433, 490, 384, 460, 407, 461, 433, 485, 1224, 482, 386, 509, 385, 484, 384, 460, 1249, 483, 1252, 485, 1224, 461, 1249, 483, 411, 483, 1226, 460, 1248, 484, 411, 484, 1225, 460, 1249, 483, 411, 484, 384, 483, 1226, 483, 411, 460, 407, 461, 1248, 461, 434, 484, 383, 460, 1249, 484, 1252, 484, 383, 483, 1227, 484, 1251, 484, 1225, 460, 408, 460, 434, 483, 384, 461, 407, 460, 434, 485, 383, 483, 385, 460, 434, 484, 1225, 460, 1249, 483, 1252, 484, 1225, 460, 1249, 484, 1252, 483, 1226, 460, 408, 482, 412, 484, 383, 460, 408, 460, 1275, 485, 383, 483, 384, 510, 1226, 484, 1225, 460, 1249, 484, 1252, 484, 1225, 460, 407, 484, 1252, 484, 1225, 483, 385, 460, 1000000000001000000000000000001011111101111111110000000001100111100110001001000101101110100000000111111111111100000000111000010001111011011001001001101110000000011111110000100111110110

//22 ON
//3445, 1644, 484, 1226, 536, 357, 461, 407, 460, 408, 511, 382, 461, 407, 461, 407, 511, 383, 461, 407, 460, 408, 511, 383, 460, 407, 461, 1249, 509, 384, 461, 407, 512, 356, 512, 382, 460, 407, 461, 408, 510, 383, 461, 407, 460, 408, 512, 382, 460, 407, 461, 407, 511, 383, 484, 384, 483, 384, 512, 382, 484, 384, 484, 1225, 511, 383, 484, 1226, 483, 1226, 510, 1225, 484, 1225, 484, 1225, 512, 1223, 484, 384, 484, 1226, 510, 1225, 484, 1225, 484, 1225, 512, 1223, 485, 1224, 486, 1223, 511, 1225, 485, 1224, 485, 382, 486, 409, 485, 382, 486, 382, 510, 384, 485, 383, 485, 382, 512, 382, 486, 382, 485, 1224, 510, 1225, 486, 382, 485, 383, 486, 1249, 485, 1224, 485, 1225, 486, 1249, 485, 377, 485, 388, 487, 1249, 485, 1224, 485, 382, 487, 407, 485, 383, 485, 1228, 483, 407, 485, 383, 485, 1224, 487, 407, 485, 383, 484, 384, 508, 1227, 484, 384, 484, 1225, 511, 1224, 484, 384, 484, 1225, 487, 1249, 483, 1225, 460, 408, 513, 1223, 459, 408, 460, 408, 512, 382, 459, 409, 459, 408, 513, 381, 460, 408, 459, 409, 512, 1223, 460, 1249, 460, 1250, 512, 1223, 459, 1250, 459, 1250, 486, 1249, 460, 1250, 459, 1250, 512, 1223, 460, 1249, 460, 1250, 512, 1223, 459, 408, 460, 408, 513, 381, 460, 408, 460, 408, 512, 382, 459, 408, 460, 408, 513, 1222, 460, 1249, 460, 1250, 512, 1223, 460, 1249, 460, 1249, 513, 1223, 459, 408, 460, 408, 510, 384, 460, 408, 460, 408, 512, 382, 459, 408, 460, 408, 512, 1223, 460, 1249, 460, 1249, 513, 381, 460, 1249, 460, 1250, 512, 382, 459, 408, 460, 1249, 513, 381, 460, 408, 460, 1249, 539, 350, 463, 410, 459, 1250, 513, 1222, 460, 408, 460, 1249, 486, 1250, 459, 1250, 459, 408, 513, 381, 460, 408, 460, 408, 512, 382, 460, 408, 459, 408, 513, 381, 460, 1249, 460, 1250, 512, 1223, 459, 1250, 459, 1250, 512, 1224, 459, 1250, 459, 408, 513, 381, 460, 408, 460, 408, 512, 1223, 460, 408, 459, 409, 485, 1250, 459, 1250, 459, 1251, 512, 1222, 460, 1250, 459, 408, 512, 1224, 459, 1250, 459, 408, 460, 1000000000001000000000000000001011111101111111110000000001100111100110001001000101101110100000000111111111111100000000111111100000000111011001001001101110000000011111110000100111110110


//21 ON 
//3421, 1671, 485, 1224, 511, 383, 484, 384, 485, 382, 486, 408, 486, 382, 485, 383, 509, 385, 484, 384, 485, 382, 485, 409, 485, 383, 485, 1224, 485, 409, 484, 384, 485, 382, 511, 383, 485, 383, 485, 383, 485, 409, 485, 382, 486, 382, 511, 383, 486, 382, 485, 383, 485, 409, 485, 382, 486, 382, 511, 383, 484, 384, 485, 1224, 484, 410, 485, 1224, 485, 1224, 486, 1249, 485, 1225, 485, 1224, 485, 1250, 485, 383, 485, 1224, 485, 1250, 486, 1223, 486, 1224, 511, 1224, 485, 1224, 486, 1223, 486, 1250, 485, 1224, 485, 382, 512, 382, 485, 383, 486, 382, 485, 409, 485, 383, 485, 382, 510, 384, 485, 383, 485, 1224, 486, 1250, 485, 382, 486, 382, 485, 1250, 486, 1224, 485, 1224, 511, 1224, 484, 383, 486, 382, 486, 1250, 485, 1224, 486, 382, 511, 383, 485, 382, 486, 1223, 486, 409, 485, 382, 486, 1223, 486, 408, 485, 383, 485, 383, 484, 1251, 485, 383, 485, 1224, 485, 1250, 486, 382, 485, 1224, 511, 1225, 484, 1225, 485, 382, 486, 1250, 485, 382, 486, 382, 511, 383, 484, 384, 485, 383, 485, 409, 485, 382, 486, 382, 485, 1251, 484, 1225, 485, 1224, 485, 1250, 485, 1224, 486, 1223, 510, 1226, 485, 1224, 485, 1224, 511, 1225, 484, 1225, 485, 1224, 485, 1250, 485, 383, 485, 382, 512, 382, 485, 383, 486, 382, 485, 409, 485, 383, 485, 382, 512, 1224, 485, 1224, 485, 1224, 485, 403, 486, 1229, 485, 1224, 485, 1251, 484, 383, 485, 383, 509, 385, 485, 383, 485, 1224, 485, 409, 485, 383, 484, 383, 512, 1224, 485, 1224, 484, 1225, 484, 410, 484, 1225, 484, 1225, 512, 382, 485, 383, 484, 1225, 484, 410, 484, 384, 484, 1225, 460, 434, 485, 383, 483, 1226, 460, 1275, 484, 384, 483, 1226, 511, 1225, 483, 1226, 483, 384, 512, 382, 485, 383, 483, 385, 482, 412, 460, 407, 461, 407, 512, 382, 485, 1224, 461, 1249, 483, 1252, 483, 1226, 483, 1226, 512, 1223, 483, 1226, 461, 407, 461, 433, 484, 384, 460, 408, 460, 1275, 484, 384, 483, 385, 509, 1226, 484, 1225, 460, 1249, 460, 1276, 460, 1249, 483, 384, 512, 1224, 484, 1225, 460, 408, 460, 1000000000001000000000000000001011111101111111110000000001100111100110001001000101101110100000000111111111111100000000111011100001000111011001001001101110000000011111110000100111110110





#include <PubSubClient.h>
#include <ESP8266WiFi.h>

#define LEDPIN 13
#define maxLen 800

volatile  unsigned int irBuffer[maxLen]; //stores timings - volatile because changed by ISR
volatile unsigned int x = 0; //Pointer thru irBuffer - volatile because changed by ISR

int times[maxLen];
unsigned int pulse_count = 0 ;
unsigned int pause_count = 0 ;
int current_pulse;
unsigned int pause_flag = 0 ;

unsigned int PIN_ON_NODEMCU = 0; // INT 0 on Arduino Mega == D3 on Node mcu

// wifi AP details
const char* ssid = "SEIL";
const char* password = "deadlock123";

// MQTT broker details
const char* mqtt_server = "10.129.23.30";
//const char* mqtt_username = "<MQTT_BROKER_USERNAME>";
//const char* mqtt_password = "<MQTT_BROKER_PASSWORD>";
const char* mqtt_topic = "data/SEIL/IRReceiver/AC2";

// declaring WiFi client and wrapping it in Pub-Sub Mechanism
WiFiClient espClient;
PubSubClient client(espClient);

void setup() {
  // put your setup code here, to run once:
  Serial.begin(9600); //change BAUD rate as required
  
  //set up wifi
//  setup_wifi();
  
  //setup broker connection
  client.setServer(mqtt_server, 1883);
  client.setCallback(callback);

  // attach interrupt pin to one pin on NODEMCU
  //pinMode(PIN_ON_NODEMCU, INPUT_PULLUP);
  attachInterrupt(PIN_ON_NODEMCU, rxIR_Interrupt_Handler, CHANGE);//set up ISR for receiving IR signal // GPIO 5 on arduino and D1 on nodeMCU

}

void loop() {

//  if (!client.connected()) {
//    reconnect();
//  }
//  client.loop();
//  
  // put your main code here, to run repeatedly:
  Serial.println(F("Press the button on the remote now - once only"));
  delay(5000); // pause 5 secs
  if (x) { //if a signal is captured
    digitalWrite(LEDPIN, HIGH);//visual indicator that signal received
    Serial.println();
  
    detachInterrupt(PIN_ON_NODEMCU);//stop interrupts & capture until finshed here
    for (int i = 1; i < x; i++) 
    { //now dump the times
      if (!(i & 0x1)) 
      {
        //Serial.print(F("-"));
        pause_flag = 1 ;
        pause_count ++ ;
      }
      current_pulse = irBuffer[i] - irBuffer[i - 1] ;
      //Serial.print(current_pulse);
      //Serial.print(F(","));
      if (pause_flag)
      {
        times[pulse_count] = current_pulse * -1;
        pause_flag=0 ;
      }
      else
      {
        times[pulse_count] = current_pulse;
      }
      pulse_count ++ ;
      //Serial.print(F(", "));
    }
   
    getBitStream(times, pulse_count, pause_count);
    x = 0;
    pulse_count  = 0 ;
    pause_count = 0 ;
    Serial.println();
    Serial.println();
   
    digitalWrite(LEDPIN, LOW);//end of visual indicator, for this time
    attachInterrupt(PIN_ON_NODEMCU, rxIR_Interrupt_Handler, CHANGE);//re-enable ISR for receiving IR signal
  }
  else
  {
    Serial.println("Sending 'ALIVE' to the broker ...");
//    client.publish(mqtt_topic, "ALIVE");
  }

}

void setup_wifi()
{
  delay(10);
  // We start by connecting to a WiFi network
  Serial.println();
  Serial.print("Connecting to ");
  Serial.println(ssid);

  WiFi.begin(ssid, password);

  while (WiFi.status() != WL_CONNECTED) {
    delay(500);
    Serial.print(".");
  }

  Serial.println("");
  Serial.println("WiFi connected");
  Serial.println("IP address: ");
  Serial.println(WiFi.localIP());
}

void callback(char* topic, byte* payload, unsigned int length) {
  Serial.print("Message arrived [");
  Serial.print(topic);
  Serial.print("] ");
  for (int i = 0; i < length; i++) {
    Serial.print((char)payload[i]);
  }
  Serial.println();
}

void reconnect() {
  // Loop until we're reconnected
  while (!client.connected()) {
    Serial.print("Attempting MQTT connection...");
    // Attempt to connect
    if (client.connect("ACReceiver_2")) {
      Serial.println("connected");
    } else {
      Serial.print("failed, rc=");
      Serial.print(client.state());
      Serial.println(" try again in 5 seconds");
      // Wait 5 seconds before retrying
      delay(5000);
    }
  }
}


void getBitStream(int pulse_and_pause[], unsigned int array_len, unsigned int pauses )
{
  Serial.print("Received code is of size ");
  char bitStream [pauses];
  unsigned int bitCounter = 0 ;
  Serial.println(array_len);
for(int i = 0; i < array_len; i++)
{
  Serial.print(abs(pulse_and_pause[i]));
  Serial.print(", ");
  
}
  
  for (int i = 2 ; i< array_len ; i++)
  {
     if ( pulse_and_pause[i] < 0 )
     {
        if (pulse_and_pause[i] > 800 * -1) // ignoring positive values and making short pauses 0
         {
           bitStream[bitCounter] = '0';
           
         }
         else // making long pauses 1
         {
           bitStream[bitCounter] = '1';
         }
         
         //Serial.print(pulse_and_pause[i]);
         //Serial.print(F(","));
         bitCounter ++ ;
      
     }
  
  }

  bitStream[bitCounter] = '\0';    
  Serial.println(bitStream);
  Serial.println("Sending data to the broker ...");
  client.publish(mqtt_topic, bitStream);
}


void rxIR_Interrupt_Handler() {
  if (x > maxLen) return; //ignore if irBuffer is already full
  irBuffer[x++] = micros(); //just continually record the time-stamp of signal transitions

}

